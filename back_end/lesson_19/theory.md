# Lesson 19

## Отправка email по почте

## 00. Замечания и определения

* Транзакция - последовательность операций, которая должна выполняться либо полностью, либо не выполняться вообще
* На уровне БД реализуется с помощью команд `BEGIN` - начало транзакции, `COMMIT` - фиксация транзакции, `ROLLBACK` - откат изменений
* На уровне Spring-приложения можно использовать аннотацию `@Transactional`

## 01.  Реализовать функционал для создания ссылки подтверждения регистрации

* Создать модель `ConfirmationCode`
* Добавить зависимость в `pom.xml` - `spring-boot-starter-mail`
* Добавить нужные свойства в `applicaiton.yml`
* Реализовать класс `TemplateProjectMailSender`, который является оберткой над `JavaMailSender`
* На метод `send` класса `TemplateProjectMailSender` нужно повесить `@Async`, чтобы этот метод выполнялся в другом потоке (треде)
* В классе с mail-методом поставить аннотацию `@EnableAsync`

## Важные ссылки

* [Как получить пароль приложения](https://help.case.one/2022/07/11/%D0%BA%D0%B0%D0%BA-%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B8%D1%82%D1%8C-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8C-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F-google/)
* [Получение пароля для вашего аккаунта](https://myaccount.google.com/apppasswords)
* [В целом про работу с SMTP Gmail](https://kinsta.com/blog/gmail-smtp-server/)


Freemarker — это шаблонизатор на Java, который помогает разработчикам генерировать HTML-страницы, конфигурационные файлы и другие текстовые форматы, используя шаблоны. Этот инструмент широко применяется для создания веб-страниц в Java-приложениях. Вот подробное описание работы с Freemarker для создания страниц в Java-приложении:

### Основы Freemarker

Freemarker не обрабатывает HTML сам по себе; он создаёт HTML-файлы на основе шаблонов, которые вы определяете. Шаблоны Freemarker написаны в собственном декларативном языке и содержат статический текст (который будет частью конечного документа) и директивы Freemarker, которые управляют созданием динамического контента.

### Компоненты Freemarker

1. **Шаблоны**: Шаблоны Freemarker (обычно с расширением `.ftl`) — это текстовые файлы, содержащие фиксированный текст и специальные конструкции для динамической вставки данных.

2. **Модель данных**: Данные, которые должны быть вставлены в шаблон, обычно представлены в виде карты (Map) или другой структуры данных в Java, которая передаётся в шаблонизатор при обработке.

3. **Конфигурация**: Объект Configuration в Freemarker управляет всеми аспектами поведения шаблонизатора, включая спецификации форматирования, локализацию и другие настройки.

### Пример работы с Freemarker

#### 1. Настройка

Перед использованием Freemarker в вашем проекте добавьте зависимость в ваш `pom.xml` или `build.gradle` файл:

```xml
<!-- Для Maven -->
<dependency>
    <groupId>org.freemarker</groupId>
    <artifactId>freemarker</artifactId>
    <version>2.3.31</version> <!-- Проверьте последнюю версию -->
</dependency>
```

```groovy
// Для Gradle
implementation 'org.freemarker:freemarker:2.3.31' // Проверьте последнюю версию
```

#### 2. Создание конфигурации

```java
import freemarker.template.Configuration;
import freemarker.template.Version;

Configuration cfg = new Configuration(new Version("2.3.31"));
cfg.setDirectoryForTemplateLoading(new File("/path/to/templates"));
cfg.setDefaultEncoding("UTF-8");
cfg.setLocale(Locale.US);
cfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
```

#### 3. Подготовка модели данных

```java
Map<String, Object> root = new HashMap<>();
root.put("user", "John Doe");
List<String> messages = Arrays.asList("Your application is up and running.", "Enjoy Freemarker!");
root.put("messages", messages);
```

#### 4. Обработка шаблона

```java
/* Загрузите шаблон */
Template temp = cfg.getTemplate("test.ftl");

/* Соедините модель данных с шаблоном и выводите результаты */
try (Writer out = new OutputStreamWriter(System.out)) {
    temp.process(root, out);
}
```

#### 5. Шаблон test.ftl

```plaintext
<html>
<head>
  <title>Welcome</title>
</head>
<body>
  <h1>Welcome ${user}!</h1>
  <p>Messages:</p>
  <ul>
  <#list messages as message>
    <li>${message}</li>
  <#list>
  </ul>
</body>
</html>
```

Этот пример демонстрирует базовый процесс создания HTML-страницы с использованием динамических данных.
Freemarker мощный и гибкий, поддерживающий сложные операции с данными и форматированием текста.

### Загрузка файлов в Spring Boot

В Spring Boot загрузка и выгрузка файлов обычно выполняются с помощью Spring MVC, используя контроллеры.
Для этих задач можно использовать встроенную поддержку обработки многокомпонентных (multipart) файлов.

#### Конфигурация MultipartResolver

Spring Boot автоматически настраивает `MultipartResolver`, если в classpath присутствует соответствующая библиотека. Однако, вы можете настроить параметры загрузки файлов в `application.properties` или `application.yml`:

```properties
spring.servlet.multipart.max-file-size=2MB
spring.servlet.multipart.max-request-size=2MB
```


### Path

`Path` в Java представляет собой интерфейс, который является частью пакета `java.nio.file` и используется для представления пути к файлу или директории в файловой системе.
Он предоставляет более современный и гибкий подход к работе с файловыми путями по сравнению с классом `File` из `java.io`.
`Path` позволяет выполнять множество операций, таких как извлечение имени файла, родительской директории,
проверка существования файла и чтение атрибутов файла без открытия файла. Используя `Path`, можно создавать новые пути,
объединять их с другими путями, удалять избыточные элементы и преобразовывать относительные пути в абсолютные.
`Path` работает в тесной связке с другими классами в `java.nio.file`, такими как `Files` и `FileSystem`,
которые предоставляют дополнительные методы для работы с файлами и директориями. С помощью `Path` можно также наблюдать
за изменениями в файловой системе через `WatchService`. Методы вроде `resolve` и `normalize` обеспечивают удобные средства
для работы с путями в контексте файловой системы.

### Resource

`Resource` — это интерфейс в Spring Framework, предназначенный для абстрактной работы с низкоуровневыми ресурсами.
Он позволяет обеспечить универсальный доступ к различным источникам данных, будь то файл на диске, ресурс в JAR-файле,
или файл по сетевому адресу. `Resource` предоставляет методы для получения `InputStream`, что делает возможным чтение
содержимого ресурса независимо от его фактического местоположения. Он также позволяет проверять, существует ли ресурс,
и получать информацию о нём, такую как URL или URI. Spring автоматически использует соответствующую реализацию `Resource`
в зависимости от синтаксиса URI, который вы используете. Этот интерфейс находит применение во многих частях Spring,
включая загрузку конфигурационных файлов и ресурсов шаблонов. `Resource` облегчает работу с ресурсами в приложениях,
предоставляя единый API для работы с разнообразными источниками данных.

### UrlResource

`UrlResource` — это конкретная реализация интерфейса `Resource` в Spring Framework, которая предназначена для доступа к ресурсам по URL.
Этот класс оборачивает `java.net.URL`, предоставляя доступ к ресурсам, которые могут быть доступны через стандартные протоколы,
такие как HTTP, HTTPS, FTP, и файловые системы. `UrlResource` полезен в ситуациях, когда ресурсы должны быть загружены из внешнего
источника или когда необходимо взаимодействовать с ресурсами, которые доступны через сетевой протокол.
Он поддерживает различные операции, включая проверку существования ресурса, получение `InputStream` для чтения данных и
получение информации о ресурсе, такой как его `URI` или `URL`. `UrlResource` часто используется в веб-приложениях для загрузки
контента из интернета или доступа к файлам в локальной файловой системе через URL

. Также он может использоваться для интеграции с другими веб-сервисами, предоставляя гибкий и мощный способ работы с внешними ресурсами.

### MultipartFile

`MultipartFile` — это интерфейс в Spring Framework, используемый для представления загруженного файла в многокомпонентной (multipart) форме.
Этот интерфейс облегчает обработку загруженных файлов в веб-приложениях, предоставляя методы для получения имени файла, его содержимого,
размера и типа контента. `MultipartFile` применяется в контроллерах Spring MVC, где файлы загружаются пользователем через веб-формы.
С помощью `getBytes()` можно извлечь содержимое файла в виде массива байтов, а `getInputStream()` позволяет прочитать содержимое файла
как поток данных. `MultipartFile` также поддерживает методы для сохранения файла напрямую в файловую систему с использованием `transferTo()`.
Этот интерфейс широко используется в приложениях, где требуется обработка файлов, загруженных пользователями, например, в сервисах обмена
фотографиями или документами. Он обеспечивает безопасную и эффективную обработку файловых данных, управляя сложностями, связанными с
многокомпонентной загрузкой файлов.

### RedirectAttributes

`RedirectAttributes` — это специализированный тип данных в Spring MVC, который используется для передачи атрибутов в перенаправленных
запросах. Этот интерфейс позволяет сохранять атрибуты в течение одного редиректа, что полезно при реализации шаблона Post/Redirect/Get,
обеспечивая, чтобы параметры или сообщения об ошибках не терялись между запросами. `RedirectAttributes` обычно используется для добавления атрибутов,
которые должны быть доступны после перенаправления клиента на другой URL, например, сообщения о успешной загрузке файла или ошибке.
С помощью методов `addFlashAttribute` можно добавить данные, которые будут автоматически удалены после того, как они будут использованы в
следующем запросе, что предотвращает дублирование информации при обновлении страницы. `RedirectAttributes` интегрирован в Spring MVC и работает
в сочетании с `RedirectView`, облегчая разработчикам управление состоянием приложения между перенаправлениями.
Этот механизм особенно важен в веб-приложениях, где необходимо поддерживать состояние без использования сессии или сохранения состояния на стороне клиента.


